<!DOCTYPE html>
<html>
    <head>
        <title>show svg</title>
        <script type="text/javascript" src="cj.js"></script>
        <script type="text/javascript">
        var kr = 39;
        var kl = 37;
        var k1 = 49;
        var k2 = 50;
        var k3 = 51;
        var k4 = 52;
        var right = 0;
        var wrong = 0;
        var total = 0;
        var right_percent = 0.0;
        var percent = 0.0;
        var chars_flag = [];
        var index = 0;
        var ans = [];
        var correct_ans = 0;
        var view = document.getElementById('view');
        var prev = document.getElementById('prev');
        var next = document.getElementById('next');
        var stat = document.getElementById('stat');
        var score = document.getElementById('score');
        var input = document.getElementById('input');

        function adjustIndex() {
            var len = ws.length;
            if (index >= len) {
                index = index % len;
            }
            if (index < 0) {
                index = len - 1;
            }
        }
        
        function getAnswers(ch) {
            var alphas = Array('a','b','c','d','e','f','g','h','i','j','k','l','m',
                                'n','o','p','q','r','s','t','u','v','w','x','y','z');
            delete alphas[alphas.indexOf(ch)];
            alphas.sort(function() {return 0.5 - Math.random();});
            var answers = alphas.slice(0,3);
            answers.push(ch);
            answers.sort(function() {return 0.5 - Math.random();});
            return answers;
        }
        function updateView() {
            adjustIndex();
            view.src = ws[index];
            var chars = {
                'a':'日[A]','b':'月[B]','c':'金[C]','d':'木[D]','e':'水[E]','f':'火[F]',
                'g':'土[G]','h':'竹[H]','i':'戈[I]','j':'十[J]','k':'大[K]','l':'中[L]',
                'm':'一[M]','n':'弓[N]','o':'人[O]','p':'心[P]','q':'手[Q]','r':'口[R]',
                's':'尸[S]','t':'廿[T]','u':'山[U]','v':'女[V]','w':'田[W]','x':'難[X]',
                'y':'卜[Y]','z':'重[Z]'
                };
            var ch = ws[index].charAt(3);
            ans = getAnswers(ch);
            var ansTxt = '';
            for (var i = 0; i < ans.length; i++) {
                ansTxt += ' ('+(i+1)+')' + chars[ans[i]] + ' ';
            }
            stat.innerHTML = ws[index] + ansTxt;
            correct_ans = ans.indexOf(ch);
            
            var scoreTxt = '';
            scoreTxt += '正確: ' + right;
            scoreTxt += ' 錯誤: '+ wrong;
            scoreTxt += ' 正確率:' + right_percent + '%';
            scoreTxt += ' 完成率:' + percent + '%';
            score.innerHTML = scoreTxt;
            
            input.value = '';
            input.focus();
        }
        
        function shuffle() {
            index = Math.floor(Math.random() * ws.length);
            updateView();
        }
        
        function reset() {
            kr = 39;
            kl = 37;
            k1 = 49;
            k2 = 50;
            k3 = 51;
            k4 = 52;
            right = 0;
            wrong = 0;
            total = 0;
            right_percent = 0.0;
            percent = 0.0;
            chars_flag = [];
            index = 0;
            ans = [];
            correct_ans = 0;
        }

        function init() {
            view = document.getElementById('view');
            prev = document.getElementById('prev');
            next = document.getElementById('next');
            stat = document.getElementById('stat');
            score = document.getElementById('score');
            input = document.getElementById('input');
            
            reset();

            input.focus();
            input.addEventListener('keypress', check_ans);

            shuffle();
            // updateView();

            prev.addEventListener('click', prevView());
            next.addEventListener('click', nextView());
            document.onkeypress = function(e) {
                e = e || window.event;
                var kc = event.keyCode;
                if (kc == kr) { //left
                    index ++;
                } else if (kc == kl) {//right
                    index --;
                }
                updateView();
            };
        }
        function prevView() {
            index--;
            updateView();
        }
        function nextView() {
            index++;
            updateView();
        }
        function setCookie(cname, cvalue, exdays) {
            var d = new Date();
            d.setTime(d.getTime() + (exdays*24*60*60*1000));
            var expires = "expires="+d.toUTCString();
            document.cookie = cname + "=" + cvalue + "; " + expires;
        }
        function getCookie(cname) {
            var name = cname + "=";
            var ca = document.cookie.split(';');
            for(var i=0; i<ca.length; i++) {
                var c = ca[i];
                while (c.charAt(0)==' ') c = c.substring(1);
                if (c.indexOf(name) == 0) return c.substring(name.length,c.length);
            }
            return "";
        } 
        function updateWrongCookie(user_ans) {
            var cookie = None;
            var kk = ws[index].substring(3)+'_'+answers[user_ans];
            var saved_cookie_str = getCookie(kk);
            if (saved_cookie_str != "") {
                cookie = {
                    'svg' : kk,
                    'answers' : answers,
                    'user_ans' : user_ans,
                    'correct_ans' : correct_ans,
                    'count' : count
                };
            } else {
                cookie = JSON.parse(saved_cookie_str);
                cookie['count'] ++;
            }
            var cookie_str = JSON.stringify(cookie);
            setCookie(kk, cookie_str);
        }
        function updateScore(user_ans) {
            if (user_ans == correct_ans) {
                right++;
            } else {
                wrong++;
                updateWrongCookie()
            }
            total ++;
            
            // 2 digit after period
            right_percent = Math.floor(10000 * right / total) / 100; 
            
            chars_flag[index] = 1;
            var len = ws.length;
            if (!((len-1) in chars_flag)) {
                chars_flag[len - 1] = 0;
            }
            var char_count = 0;
            for (var i = 0; i < len; i++) {
                if (i in chars_flag && chars_flag[i] != 0) {
                    char_count ++;
                }
            }
            percent = Math.floor(10000 * char_count / len) / 100; 
        } 
        function check_ans(e) {
            e = e || window.event;
            var kc = e.keyCode ? e.keyCode : e.which;;
            var user_ans = -1;
            var ans_ch = String.toLowerCase(String.fromCharCode(kc());
            if (kc == k1 ||
                kc == k2 ||
                kc == k3 ||
                kc == k4) {
                user_ans = kc - k1;
            } else if (ans_ch in answers) {
                user_ans = answers.indexOf(ans_ch);
            }
            if (user_ans != -1) {
                updateScore(user_ans);
                shuffle();
            }
        }
        </script>
    </head>
    <body onload="init()">
        <h1>倉頡練習</h1>
        <div id=img><img id=view src="s2/a01.svg"></img></div>
        <table>
            <tr>
                <td colspan=3><input value="" id=input size=1/></td>
                <div id=stat></div>
            </tr>
            <tr>
                <td colspan=3><div id=score></div></td>
            </tr>
            <tr>
                <td><div id=prev><input type="button" value="prev" onclick="prevView()" /></div></td>
                <td><div id=prev><input type="button" value="shuffle" onclick="shuffle()" /></div></td>
                <td><div id=next><input type="button" value="reset" onclick="init()" /></div></td>
                <td><div id=next><input type="button" value="next" onclick="prevView()" /></div></td>
            </tr>
        </table>
    </body>
</html>